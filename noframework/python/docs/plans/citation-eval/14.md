# Task 14: Correction Workflow

## Design Reference
- [tech-design.md §15](../../design/citation-eval/tech-design.md#15-correction-workflow)
- [tech-design.md §15.3](../../design/citation-eval/tech-design.md#153-correction-interface)
- [tech-design.md §15.4](../../design/citation-eval/tech-design.md#154-correction-strategies)

## Objective
Implement iterative citation correction loop targeting 100% accuracy.

## Requirements

### R14.1: CitationCorrection Data Structure
Per tech-design.md §15.3:
- Reference to original FailedCitation
- Action taken: replaced_reference, rewrote_claim, removed_citation, expanded_range, no_change
- New values: new_citation, new_claim_text (if applicable)
- Correction reasoning

### R14.2: CorrectionResult Data Structure
- List of corrections applied
- Remaining failures count (target: 0)
- Iteration count

### R14.3: Invalid Reference Strategy
Per tech-design.md §15.4.1:
- Extract key terms from claim
- Search cache for files containing terms
- Find matching line ranges
- Propose new reference or flag for manual review

### R14.4: Non-Supporting Code Strategy
Per tech-design.md §15.4.2:
- Parse LLM explanation for mismatch
- Option A: Search for code that supports claim
- Option B: Rewrite claim to match cited code
- Option C: Remove citation if inferential

### R14.5: Low Confidence Strategy
Per tech-design.md §15.4.3:
- Expand line range for more context
- Re-evaluate with expanded range
- Escalate to gpt-4o if still uncertain
- Flag for human review as last resort

### R14.6: Iteration Control
Per tech-design.md §15.6:
- `max_correction_iterations` default 3
- `max_failures_for_auto` default 10 (above = manual review)
- Exit on: 0 failures, iteration limit, or manual required

### R14.7: Report Integration
- Apply corrections to report markdown
- Re-run evaluation after corrections
- Loop until success or limit reached

### R14.8: CLI Flags
Per tech-design.md §15.7:
- `--eval` - Evaluate only, report failures
- `--eval --correct` - Evaluate and auto-correct
- `--eval --correct --strict` - Fail if any remain unfixed

## Dependencies
- Task 13: Failed citation output
- Task 8: Pipeline orchestration (for re-evaluation)

## Test Plan

| Test | Input | Expected |
|------|-------|----------|
| No failures | Perfect report | No corrections needed, exit immediately |
| Fix invalid file | Wrong filename | Searches cache, proposes correct file |
| Fix invalid range | Out of bounds | Proposes valid range |
| Rewrite claim | Claim doesn't match code | Produces rewritten claim matching code |
| Replace reference | Code exists elsewhere | Finds correct location |
| Expand range | Low confidence | Widens range, re-evaluates |
| Iteration success | 3 failures, all fixable | 0 failures after corrections |
| Iteration limit | Unfixable failures | Exits at max iterations, reports remaining |
| Manual threshold | 15 failures | Exits immediately, requires manual review |
| Strict mode | 1 unfixable | Exit code indicates failure |

## Acceptance Criteria
- [ ] All correction strategies from §15.4 implemented
- [ ] Iteration loop respects limits from §15.6
- [ ] Corrections applied to report markdown
- [ ] Re-evaluation confirms fixes
- [ ] CLI flags work per §15.7
- [ ] Success = 0 failed citations
