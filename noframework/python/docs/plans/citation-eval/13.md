# Task 13: Failed Citation Output

## Design Reference
- [tech-design.md §15.2](../../design/citation-eval/tech-design.md#152-failed-citation-output)
- [tech-design.md §8.6](../../design/citation-eval/tech-design.md#86-evalresult)

## Objective
Produce structured output of failed citations with enough context for the correction workflow.

## Requirements

### R13.1: FailedCitation Data Structure
Per tech-design.md §15.2:
- Location: section, paragraph_index, claim_text
- Citation details: parsed citation, cited_code
- Failure details: failure_type, failure_reason
- Correction hints: suggested_action, llm_reasoning

### R13.2: Failure Type Classification
Categorize failures as:
- `invalid_file` - File doesn't exist in cache
- `invalid_range` - Line range out of bounds
- `not_supporting` - Code doesn't support claim (LLM verdict)
- `low_confidence` - LLM uncertain about verdict

### R13.3: Suggested Action Mapping
Map failure types to correction actions:
- `invalid_file` → `fix_reference`
- `invalid_range` → `fix_reference` or `expand_range`
- `not_supporting` → `rewrite_claim` or `fix_reference`
- `low_confidence` → `expand_range`

### R13.4: Integration with EvalResult
- EvalResult.failed_citations populated by pipeline
- EvalResult.needs_correction property returns True if any failures
- EvalResult.is_perfect property for 100% success

### R13.5: Output Format
- JSON serializable for inter-process communication
- Human-readable summary to stderr
- Machine-readable full output with `--eval-json`

## Dependencies
- Task 8: Pipeline orchestration (produces failures)
- Task 9: Aggregation (populates EvalResult)

## Test Plan

| Test | Input | Expected |
|------|-------|----------|
| No failures | All citations valid | `failed_citations=[]`, `is_perfect=True` |
| Invalid file | Citation to nonexistent file | `failure_type="invalid_file"` |
| Invalid range | Line 999 in 100-line file | `failure_type="invalid_range"` |
| Not supporting | Code doesn't match claim | `failure_type="not_supporting"`, reasoning present |
| Low confidence | LLM confidence < 0.7 | `failure_type="low_confidence"` |
| Mixed failures | Multiple failure types | Each categorized correctly |
| JSON output | `--eval-json` flag | Valid JSON with all FailedCitation fields |

## Acceptance Criteria
- [ ] FailedCitation dataclass matches tech-design.md §15.2
- [ ] All four failure types correctly classified
- [ ] Suggested actions logically map to failure types
- [ ] EvalResult.needs_correction works correctly
- [ ] JSON output parseable by correction workflow
