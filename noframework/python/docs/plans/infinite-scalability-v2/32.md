# Task 32: Add CLI Control Flags

## Objective
Add missing CLI flags from the design spec: `--max-exploration`, `--max-sections`, `--persist-cache`.

## Dependencies
- Task 22: CLI implementation
- Task 31: Agentic section generation (for `max_exploration` to be meaningful in sections)

## Problem Statement

The design spec (lines 376-391) specifies:
```bash
python -m tech_writer --prompt prompt.md --repo /path/to/repo --max-exploration 30
python -m tech_writer --prompt prompt.md --repo /path/to/repo --max-sections 20
python -m tech_writer --prompt prompt.md --repo /path/to/repo --persist-cache
```

Current `cli.py` is missing all three flags.

## Deliverables

### 1. Update `cli.py` argument parsing

```python
parser.add_argument(
    "--max-exploration",
    type=int,
    default=50,
    help="Maximum exploration steps during Phase 1 (default: 50)",
)
parser.add_argument(
    "--max-sections",
    type=int,
    default=20,
    help="Maximum sections in the outline (default: 20)",
)
parser.add_argument(
    "--persist-cache",
    action="store_true",
    help="Persist SQLite cache to disk for debugging",
)
parser.add_argument(
    "--cache-path",
    help="Path for persistent cache file (default: .tech_writer_cache.db)",
)
```

### 2. Update `run_pipeline()` signature

```python
def run_pipeline(
    prompt: str,
    repo: str,
    cache_dir: Optional[str] = None,
    model: str = "gpt-4o",
    api_key: Optional[str] = None,
    base_url: Optional[str] = None,
    max_exploration: int = 50,
    max_sections: int = 20,
    db_path: Optional[str] = None,
) -> tuple[str, CacheStore]:
```

### 3. Wire parameters through the pipeline

```python
# In run_pipeline():

# Initialize store with optional persistence
store = CacheStore(db_path=db_path)

# Phase 1: Exploration with max_exploration
understanding = explore_codebase(prompt, repo_path, store, llm, max_steps=max_exploration)

# Phase 2: Outline with max_sections limit
outline = generate_outline(prompt, understanding, cached_files, llm)
if len(outline) > max_sections:
    outline = outline[:max_sections]

# ...
```

### 4. Update `cli.py` to pass parameters

```python
# Determine cache path
db_path = None
if args.persist_cache:
    db_path = args.cache_path or ".tech_writer_cache.db"

report, store = run_pipeline(
    prompt=prompt,
    repo=args.repo,
    cache_dir=args.cache_dir,
    model=args.model,
    base_url=args.base_url,
    max_exploration=args.max_exploration,
    max_sections=args.max_sections,
    db_path=db_path,
)
```

## Acceptance Criteria

- [ ] `--max-exploration N` limits exploration to N tool calls
- [ ] `--max-sections N` truncates outline to N sections
- [ ] `--persist-cache` saves SQLite DB to disk
- [ ] `--cache-path PATH` sets custom cache file location
- [ ] `--help` shows all new options with descriptions
- [ ] Default values match design spec (50 exploration, 20 sections)
- [ ] Parameters are wired through `run_pipeline()` to relevant functions

## Test Cases

```gherkin
Feature: CLI control flags

  Scenario: Limit exploration depth
    Given a repository with 100 files
    When I run: python -m tech_writer --prompt p.md --repo . --max-exploration 10
    Then at most 10 tool calls should be made during exploration

  Scenario: Limit sections
    Given a complex codebase that could have 30 sections
    When I run: python -m tech_writer --prompt p.md --repo . --max-sections 5
    Then the output should have at most 5 sections

  Scenario: Persist cache
    When I run: python -m tech_writer --prompt p.md --repo . --persist-cache
    Then a file ".tech_writer_cache.db" should be created
    And it should contain the cached files

  Scenario: Custom cache path
    When I run: python -m tech_writer --prompt p.md --repo . --persist-cache --cache-path /tmp/debug.db
    Then "/tmp/debug.db" should be created

  Scenario: Help text shows new options
    When I run: python -m tech_writer --help
    Then output should show --max-exploration
    And output should show --max-sections
    And output should show --persist-cache
    And output should show --cache-path
```

## Constants

```python
# In orchestrator.py or constants.py
DEFAULT_MAX_EXPLORATION_STEPS = 50
DEFAULT_MAX_SECTIONS = 20
DEFAULT_CACHE_FILENAME = ".tech_writer_cache.db"
```

## Implementation Notes

- `max_exploration` already exists as parameter in `explore_codebase()`, just not exposed
- `max_sections` is simple truncation of outline list
- `persist_cache` requires passing `db_path` to `CacheStore()`
- Cache file should be relative to current directory unless absolute path given
- Consider logging when limits are hit (e.g., "Outline truncated to 20 sections")
