# Task 26: Feature: Semantic Queries

## Objective
BDD tests for semantic tools (get_symbols, get_imports, etc.).

## Dependencies
- Task 25: Feature: exploration tools

## Deliverables

`tests/features/semantic.feature`:

```gherkin
Feature: Semantic query tools
  As a tech writer agent
  I need semantic queries about code
  So that I can understand structure without grep

  Background:
    Given the axios repository is available
    And I have read "lib/core/Axios.js"

  # get_symbols tests

  Scenario: Get all symbols
    When I call get_symbols("lib/core/Axios.js")
    Then I should get a list of symbols
    And the list should include classes and functions

  Scenario: Filter symbols by kind
    When I call get_symbols("lib/core/Axios.js", kind="function")
    Then all symbols should have kind "function"

  Scenario: Symbols have line numbers
    When I call get_symbols("lib/core/Axios.js")
    Then each symbol should have "line" property
    And each symbol should have "end_line" property

  Scenario: Symbols have signatures
    When I call get_symbols("lib/core/Axios.js")
    Then most symbols should have a "signature" property

  # get_imports tests

  Scenario: Get all imports
    When I call get_imports("lib/core/Axios.js")
    Then I should get a list of imports
    And imports should have "module" property

  Scenario: Identify relative imports
    When I call get_imports("lib/core/Axios.js")
    Then some imports should have is_relative=true

  # get_definition tests

  Scenario: Find class definition
    Given I have read multiple files in "lib/core/"
    When I call get_definition("Axios")
    Then I should find the definition
    And the path should contain "Axios"

  Scenario: Symbol not found
    When I call get_definition("NonExistentThing123")
    Then I should get None

  # get_references tests

  Scenario: Find symbol references
    Given I have read multiple files in "lib/"
    When I call get_references("Axios")
    Then I should get a list of references
    And each reference should have path, line, context

  # get_structure tests

  Scenario: Get file structure
    When I call get_structure("lib/core/Axios.js")
    Then I should get imports, classes, functions
    And classes should include their methods
```

## Step Definitions

`tests/step_defs/semantic_steps.py`:

```python
from pytest_bdd import given, when, then, parsers
from tech_writer.tools.semantic import (
    get_symbols, get_imports, get_definition,
    get_references, get_structure
)

@given(parsers.parse('I have read "{path}"'))
def read_file_for_test(path, axios_repo, store):
    from tech_writer.tools.filesystem import read_file
    read_file(path, store=store, repo_root=axios_repo)

@given(parsers.parse('I have read multiple files in "{directory}"'))
def read_multiple_files(directory, axios_repo, store):
    from tech_writer.tools.filesystem import list_files, read_file
    files = list_files("*.js", path=directory, repo_root=axios_repo)
    for f in files[:10]:  # Limit for speed
        read_file(f, store=store, repo_root=axios_repo)

@when(parsers.parse('I call get_symbols("{path}")'))
def call_get_symbols(path, store, axios_repo, context):
    context["result"] = get_symbols(path, store=store, repo_root=axios_repo)

@when(parsers.parse('I call get_symbols("{path}", kind="{kind}")'))
def call_get_symbols_filtered(path, kind, store, axios_repo, context):
    context["result"] = get_symbols(path, kind=kind, store=store, repo_root=axios_repo)

@then("I should get a list of symbols")
def check_symbols_list(context):
    assert isinstance(context["result"], list)
    assert len(context["result"]) > 0

@then(parsers.parse('all symbols should have kind "{kind}"'))
def check_all_symbols_kind(kind, context):
    for sym in context["result"]:
        assert sym["kind"] == kind
```

## Test Matrix

| Tool | Test | Input | Expected |
|------|------|-------|----------|
| get_symbols | All symbols | Axios.js | List with classes, functions |
| get_symbols | Filter by kind | kind="function" | Only functions |
| get_symbols | Line numbers | Any file | All have line, end_line |
| get_imports | All imports | Axios.js | List with module property |
| get_imports | Relative | Axios.js | Some is_relative=true |
| get_definition | Found | "Axios" | Returns location |
| get_definition | Not found | "Unknown" | Returns None |
| get_references | Found | "Axios" | List of usages |
| get_structure | Full | Axios.js | imports, classes, functions |

## Implementation Notes

- Tests require axios repo; mark as slow
- Read files before testing semantic queries
- get_definition/get_references need multiple files read
- Verify actual axios structure for assertions
