# Task 21: Report Assembly

## Objective
Combine sections into final report and handle citation issues.

## Dependencies
- Task 18: Section generation
- Task 20: Citation verification

## Deliverables

`tech_writer/orchestrator.py` (additions):

```python
@dataclass
class AssemblyResult:
    report: str
    valid_citations: int
    invalid_citations: int
    invalid_details: list[VerificationResult]

def assemble_report(
    sections: list[str],
    store: Store,
    title: str = None
) -> AssemblyResult:
    """
    Assemble sections into final report.

    Args:
        sections: List of markdown section content
        store: Cache store for citation verification
        title: Optional report title

    Returns:
        AssemblyResult with report and citation stats
    """

def handle_invalid_citations(
    report: str,
    invalid: list[VerificationResult],
    mode: str = "flag"  # "flag", "remove", "regenerate"
) -> str:
    """
    Handle invalid citations in report.

    Modes:
    - flag: Add warning markers next to invalid citations
    - remove: Remove invalid citations from text
    - regenerate: (future) re-generate affected sections
    """
```

## Acceptance Criteria

- [ ] Joins sections with proper markdown formatting
- [ ] Adds optional title/header
- [ ] Verifies all citations in assembled report
- [ ] Reports valid/invalid citation counts
- [ ] Handles invalid citations according to mode
- [ ] Preserves section structure

## Test Cases

```gherkin
Feature: Report assembly

  Scenario: Clean assembly
    Given 3 sections with valid citations
    When I assemble the report
    Then sections should be joined with proper spacing
    And all citations should be verified
    And invalid_citations should be 0

  Scenario: Flag invalid citations
    Given a section with invalid citation [nonexistent.py:1-10]
    When I assemble with mode="flag"
    Then the citation should have a warning marker
    And the warning should explain the issue

  Scenario: Remove invalid citations
    Given a section with invalid citation
    When I assemble with mode="remove"
    Then the invalid citation should be removed
    And surrounding text should remain

  Scenario: Report structure
    Given sections ["Overview", "Details", "Conclusion"]
    When I assemble the report
    Then sections should appear in order
    And there should be blank lines between sections
```

## Output Format

```markdown
# Architecture Overview

## Overview

The axios library provides... [lib/axios.js:1-10]

## Core Components

The main class... [lib/core/Axios.js:15-25]

## Request Handling

Requests are processed... [lib/core/dispatchRequest.js:30-50]

---
*Generated with tech_writer. 15 citations verified, 0 invalid.*
```

## Invalid Citation Handling

### Flag Mode (default)
```markdown
The function handles... [unknown.py:10-20] ⚠️ *[Citation not found]*
```

### Remove Mode
```markdown
The function handles...
```

## Implementation Notes

- Join sections with `\n\n` for proper markdown
- Add title as H1 if provided
- Verify citations once on final assembled report
- Footer with citation stats is optional
- Flag mode preserves content but marks issues
