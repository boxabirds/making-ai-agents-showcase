# Task 28: Feature: Section Generation

## Objective
BDD tests for agentic section generation with citations.

## Dependencies
- Task 27: Feature: outline generation

## Deliverables

`tests/features/sections.feature`:

```gherkin
Feature: Section generation
  As a tech writer agent
  I need to generate report sections
  So that I can produce complete documentation

  Background:
    Given the axios repository is available
    And the following files are cached:
      | path                |
      | lib/axios.js        |
      | lib/core/Axios.js   |

  Scenario: Generate section content
    Given a section:
      | title          | Core Axios Class                    |
      | focus          | The main Axios class and its API    |
      | relevant_files | ["lib/core/Axios.js"]               |
    When I generate the section
    Then I should get markdown content
    And content should mention "Axios"

  Scenario: Section includes citations
    Given a section about "lib/core/Axios.js"
    When I generate the section
    Then content should include at least one citation
    And citations should be in [path:line-line] format

  Scenario: Citations reference cached files
    Given a section with relevant_files ["lib/axios.js"]
    When I generate the section
    Then all citations should reference cached files

  Scenario: Section can explore more
    Given a section that needs additional context
    When I generate the section
    Then the LLM may call read_file for more info
    And new files should be added to cache

  Scenario: Section respects focus
    Given a section with focus "Error handling"
    When I generate the section
    Then content should primarily discuss errors

  Scenario: Multiple sections are coherent
    Given I have generated section "Overview"
    When I generate section "Core Axios Class"
    Then content should not repeat the overview
    And may reference it naturally

  Scenario: Max exploration steps enforced
    Given max_exploration_steps=3
    When I generate a section
    Then exploration should not exceed 3 tool calls
```

## Step Definitions

`tests/step_defs/section_steps.py`:

```python
from pytest_bdd import given, when, then, parsers
from tech_writer.orchestrator import SectionGenerator, Section

@given("a section:")
def set_section_from_table(datatable, context):
    row = datatable[0]
    context["section"] = Section(
        title=row["title"],
        focus=row["focus"],
        relevant_files=eval(row["relevant_files"])  # Parse JSON list
    )

@given(parsers.parse('a section about "{path}"'))
def set_section_about(path, context):
    context["section"] = Section(
        title=f"About {path}",
        focus=f"Document {path}",
        relevant_files=[path]
    )

@when("I generate the section")
def generate_section(context, store, axios_repo, mock_llm):
    generator = SectionGenerator(
        store=store,
        repo_root=axios_repo,
        llm_client=mock_llm,
        max_exploration_steps=context.get("max_steps", 5)
    )
    context["content"] = generator.generate(
        section=context["section"],
        prompt=context.get("prompt", "Document this"),
        previous_sections=context.get("previous_sections", [])
    )

@then("I should get markdown content")
def check_markdown_content(context):
    assert isinstance(context["content"], str)
    assert len(context["content"]) > 0

@then(parsers.parse('content should mention "{text}"'))
def check_content_mentions(text, context):
    assert text.lower() in context["content"].lower()

@then("content should include at least one citation")
def check_has_citation(context):
    import re
    citations = re.findall(r'\[[^\]]+:\d+-\d+\]', context["content"])
    assert len(citations) > 0, "No citations found"

@then("citations should be in [path:line-line] format")
def check_citation_format(context):
    import re
    citations = re.findall(r'\[([^\]]+)\]', context["content"])
    pattern = re.compile(r'.+:\d+-\d+')
    for cit in citations:
        if ':' in cit:  # Skip non-citation brackets
            assert pattern.match(cit), f"Invalid citation format: {cit}"
```

## Mock Section Response

```python
MOCK_SECTION_CONTENT = '''
## Core Axios Class

The Axios class is the foundation of the axios library [lib/core/Axios.js:1-10].

### Constructor

The constructor accepts configuration options [lib/core/Axios.js:15-25]:

```javascript
constructor(instanceConfig) {
  this.defaults = instanceConfig;
}
```

### Methods

The class provides HTTP methods [lib/core/Axios.js:30-50]:
- `request()` - Generic request method
- `get()` - GET request
- `post()` - POST request
'''
```

## Implementation Notes

- Mock LLM returns predefined section content
- Test citation extraction separately (task 29)
- Track exploration steps in generator
- Previous sections passed for coherence
