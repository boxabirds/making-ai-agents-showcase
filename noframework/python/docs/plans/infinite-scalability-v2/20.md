# Task 20: Citation Verification

## Objective
Verify that citations reference actual cached content.

## Dependencies
- Task 19: Citation parsing

## Deliverables

`tech_writer/citations.py` (additions):

```python
@dataclass
class VerificationResult:
    citation: Citation
    valid: bool
    error: str | None = None
    content: str | None = None  # The cited content if valid

def verify_citation(citation: Citation, store: Store) -> VerificationResult:
    """
    Verify a single citation against the cache.

    Checks:
    1. File exists in cache
    2. Line range exists in file
    3. Line range is valid (start <= end)

    Returns:
        VerificationResult with validity and any error
    """

def verify_all_citations(
    content: str,
    store: Store
) -> tuple[list[VerificationResult], int, int]:
    """
    Extract and verify all citations in content.

    Returns:
        (results, valid_count, invalid_count)
    """
```

## Acceptance Criteria

- [ ] Verifies file exists in cache
- [ ] Verifies line range is within file
- [ ] Returns cited content for valid citations
- [ ] Provides clear error messages for invalid
- [ ] Handles duplicate citations
- [ ] Counts valid vs invalid

## Test Cases

```gherkin
Feature: Citation verification

  Scenario: Valid citation
    Given file "src/main.py" is cached with 100 lines
    When I verify citation "src/main.py:10-20"
    Then it should be valid
    And content should contain lines 10-20

  Scenario: File not cached
    Given file "unknown.py" is NOT cached
    When I verify citation "unknown.py:10-20"
    Then it should be invalid
    And error should mention "not found" or "not cached"

  Scenario: Line range out of bounds
    Given file "src/main.py" is cached with 50 lines
    When I verify citation "src/main.py:40-60"
    Then it should be invalid
    And error should mention line range

  Scenario: Invalid range (start > end)
    Given file "src/main.py" is cached
    When I verify citation "src/main.py:20-10"
    Then it should be invalid
    And error should mention invalid range

  Scenario: Verify all in document
    Given a report with 5 citations
    And 3 are valid and 2 are invalid
    When I verify_all_citations
    Then valid_count should be 3
    And invalid_count should be 2
```

## Error Messages

```python
# File not found
"File 'unknown.py' not found in cache. Was it read during exploration?"

# Line range out of bounds
"Lines 40-60 out of range for 'src/main.py' (file has 50 lines)"

# Invalid range
"Invalid line range: start (20) must be <= end (10)"

# Start line invalid
"Line numbers must be >= 1, got 0"
```

## Implementation Notes

- Use store to look up files
- Split file content by lines to check range
- Cache line counts to avoid repeated splitting
- Return the actual content for valid citations (useful for display)
