# Task 2: SQLite Cache Store

## Objective
Implement the SQLite cache that stores files read during exploration.

## Dependencies
- Task 1: Project scaffolding

## Deliverables

`tech_writer/store.py`:

```python
class Store:
    def __init__(self, path: str = ":memory:")
    def add_file(self, path: str, content: str, lang: str) -> int
    def get_file(self, path: str) -> FileRecord | None
    def get_file_by_id(self, file_id: int) -> FileRecord | None
    def add_symbols(self, file_id: int, symbols: list[Symbol]) -> None
    def get_symbols(self, file_id: int) -> list[Symbol]
    def get_all_symbols(self) -> list[Symbol]
    def close(self) -> None
```

## Acceptance Criteria

- [ ] Store creates SQLite database (in-memory by default)
- [ ] `add_file` stores content and returns file ID
- [ ] `add_file` is idempotent (same path returns same ID)
- [ ] `get_file` retrieves by path
- [ ] `add_symbols` stores symbols linked to file
- [ ] `get_symbols` retrieves symbols for a file
- [ ] `get_all_symbols` retrieves across all files
- [ ] Store can be persisted to disk path

## Schema

```sql
CREATE TABLE files (
    id INTEGER PRIMARY KEY,
    path TEXT UNIQUE NOT NULL,
    content TEXT NOT NULL,
    lang TEXT,
    hash TEXT NOT NULL,
    cached_at TEXT NOT NULL
);

CREATE TABLE symbols (
    id INTEGER PRIMARY KEY,
    file_id INTEGER NOT NULL REFERENCES files(id),
    name TEXT NOT NULL,
    kind TEXT NOT NULL,
    line INTEGER NOT NULL,
    end_line INTEGER,
    signature TEXT,
    doc TEXT
);

CREATE INDEX idx_symbols_file ON symbols(file_id);
CREATE INDEX idx_symbols_name ON symbols(name);
```

## Test Cases

```python
def test_add_and_get_file():
    store = Store()
    file_id = store.add_file("src/main.py", "print('hello')", "python")
    record = store.get_file("src/main.py")
    assert record.id == file_id
    assert record.content == "print('hello')"

def test_add_file_idempotent():
    store = Store()
    id1 = store.add_file("src/main.py", "v1", "python")
    id2 = store.add_file("src/main.py", "v2", "python")  # Updates content
    assert id1 == id2

def test_symbols():
    store = Store()
    file_id = store.add_file("src/main.py", "def foo(): pass", "python")
    store.add_symbols(file_id, [Symbol(name="foo", kind="function", line=1)])
    symbols = store.get_symbols(file_id)
    assert len(symbols) == 1
    assert symbols[0].name == "foo"
```
