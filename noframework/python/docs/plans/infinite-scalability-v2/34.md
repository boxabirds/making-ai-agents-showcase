# Task 34: Citation Re-generation

## Objective
Implement automatic re-generation of sections with invalid citations.

## Dependencies
- Task 20: Citation verification
- Task 31: Agentic section generation

## Problem Statement

Design spec (Phase 4, lines 306-309) states:
> If invalid citations exist:
> - Flag them in the output
> - Re-generate affected sections with stricter instructions
> - Or accept best-effort output

Current implementation only flags invalid citations; it never re-generates affected sections.

## Deliverables

### 1. Add `verify_and_fix_citations()` to `orchestrator.py`

```python
MAX_CITATION_FIX_ATTEMPTS = 2

def verify_and_fix_citations(
    outline: list[Section],
    sections_content: list[str],
    store: CacheStore,
    generator: SectionGenerator,
    prompt: str,
) -> list[str]:
    """
    Verify citations and re-generate sections with invalid citations.

    Args:
        outline: Report outline
        sections_content: Generated section content
        store: Cache store for verification
        generator: Section generator for re-generation
        prompt: Original prompt

    Returns:
        Fixed sections content (same length as input)
    """
    fixed_content = list(sections_content)

    for attempt in range(MAX_CITATION_FIX_ATTEMPTS):
        # Find sections with invalid citations
        sections_to_fix = []

        for i, (section, content) in enumerate(zip(outline, fixed_content)):
            results, valid, invalid = verify_all_citations(content, store)
            if invalid > 0:
                invalid_citations = [r for r in results if not r.valid]
                sections_to_fix.append((i, section, invalid_citations))

        if not sections_to_fix:
            break  # All citations valid

        # Re-generate affected sections with stricter prompt
        for idx, section, invalid_cits in sections_to_fix:
            previous = fixed_content[:idx]
            fixed_content[idx] = generator.generate_with_citation_fix(
                section=section,
                prompt=prompt,
                previous_sections=previous,
                invalid_citations=invalid_cits,
            )

    return fixed_content
```

### 2. Add `generate_with_citation_fix()` to `SectionGenerator`

```python
CITATION_FIX_PROMPT_ADDITION = """
IMPORTANT: Your previous attempt had invalid citations. These citations were wrong:
{invalid_citations_list}

Common citation errors:
- Citing files that weren't read (use read_file first)
- Wrong line numbers (check the actual content)
- Citing non-existent lines (file may be shorter than you think)

Before making any claim, verify you have read the file and know the correct line numbers.
Use get_structure(path) to see available functions/classes and their line ranges.
"""

class SectionGenerator:
    def generate_with_citation_fix(
        self,
        section: Section,
        prompt: str,
        previous_sections: list[str],
        invalid_citations: list[VerificationResult],
    ) -> str:
        """Generate section with explicit instructions to fix citation errors."""
        # Build list of invalid citations for the prompt
        invalid_list = "\n".join(
            f"- [{r.citation.path}:{r.citation.start_line}-{r.citation.end_line}]: {r.error}"
            for r in invalid_citations
        )

        # Add citation fix instructions to the system prompt
        enhanced_prompt = SECTION_SYSTEM_PROMPT + CITATION_FIX_PROMPT_ADDITION.format(
            invalid_citations_list=invalid_list
        )

        # Run agentic generation with enhanced prompt
        context = self._build_context(section)
        prev_summary = self._build_previous_summary(previous_sections)

        tool_handlers = {
            "read_file": partial(read_file, store=self.store, repo_root=self.repo_root),
            "get_symbols": partial(get_symbols, store=self.store, repo_root=self.repo_root),
            "get_structure": partial(get_structure, store=self.store, repo_root=self.repo_root),
            "get_imports": partial(get_imports, store=self.store, repo_root=self.repo_root),
            "search_text": partial(search_text, store=self.store),
        }

        tools = [t for t in get_tool_definitions() if t["function"]["name"] in SECTION_TOOLS]

        messages = [
            {"role": "system", "content": enhanced_prompt},
            {"role": "user", "content": self._build_user_prompt(section, prompt, context, prev_summary)},
        ]

        content, _ = self.llm_client.run_tool_loop(
            messages=messages,
            tools=tools,
            tool_handlers=tool_handlers,
            max_steps=self.max_exploration_steps + 2,  # Allow extra steps for verification
        )

        return content or ""
```

### 3. Update `run_pipeline()` to use citation fixing

```python
def run_pipeline(...) -> tuple[str, CacheStore]:
    # ... existing code ...

    # Phase 3: Sections
    generator = SectionGenerator(...)
    sections_content = []
    for section in outline:
        content = generator.generate(...)
        sections_content.append(content)

    # Phase 3.5: Citation verification and re-generation
    sections_content = verify_and_fix_citations(
        outline=outline,
        sections_content=sections_content,
        store=store,
        generator=generator,
        prompt=prompt,
    )

    # Phase 4: Assembly
    report = assemble_report(prompt, outline, sections_content)

    return report, store
```

## Acceptance Criteria

- [ ] Invalid citations trigger section re-generation
- [ ] Re-generation prompt includes list of invalid citations
- [ ] Maximum 2 re-generation attempts per section
- [ ] Re-generated sections have access to tools for verification
- [ ] If citations still invalid after retries, section is kept as-is
- [ ] Valid sections are not re-generated
- [ ] Citation verification results are still available for CLI reporting

## Test Cases

```gherkin
Feature: Citation re-generation

  Scenario: Fix invalid file reference
    Given a section citing "nonexistent.py:10-20"
    And the file doesn't exist in cache
    When citation verification runs
    Then the section should be re-generated
    And the new section should cite files that exist

  Scenario: Fix invalid line numbers
    Given a section citing "main.py:100-200"
    And main.py only has 50 lines
    When citation verification runs
    Then the section should be re-generated
    And the new section should cite valid line ranges

  Scenario: Max attempts respected
    Given a section that always produces invalid citations
    When citation verification runs
    Then at most 2 re-generation attempts should be made
    And the final (possibly invalid) content should be kept

  Scenario: Valid sections not re-generated
    Given a section with all valid citations
    When citation verification runs
    Then the section should not be re-generated

  Scenario: Multiple sections need fixing
    Given sections 1, 3, 5 have invalid citations
    And sections 2, 4 have valid citations
    When citation verification runs
    Then only sections 1, 3, 5 should be re-generated
```

## Constants

```python
MAX_CITATION_FIX_ATTEMPTS = 2
```

## Implementation Notes

- Re-generation is expensive (LLM calls), so limit to 2 attempts
- Provide explicit feedback about what went wrong
- The agentic loop allows LLM to verify its citations using tools
- Consider logging which sections were re-generated and why
- Final report should still show citation stats (even if some remain invalid)
- This is a "best effort" approach - some citations may remain invalid
