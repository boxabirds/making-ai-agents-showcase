# Task 13: search_text Tool (FTS)

## Objective
Implement full-text search across cached files as a fallback tool.

## Dependencies
- Task 2: SQLite cache store

## Deliverables

`tech_writer/store.py` (additions for FTS):

```python
# Add FTS table
"""
CREATE VIRTUAL TABLE files_fts USING fts5(content, content='files', content_rowid='id');
"""

def search_text(self, query: str, limit: int = 20) -> list[dict]:
    """Search cached content using FTS."""
```

`tech_writer/tools/semantic.py` (additions):

```python
def search_text(
    query: str,
    file_pattern: str = None,
    store: Store = None
) -> list[dict]:
    """
    Full-text search across cached files.

    Use semantic tools first; this is for finding strings,
    comments, or content in unsupported languages.

    Args:
        query: Search string
        file_pattern: Optional glob to filter files (e.g., "*.md")
        store: Cache store

    Returns:
        [{"path": str, "line": int, "content": str}, ...]
    """
```

## Acceptance Criteria

- [ ] Uses SQLite FTS5 for efficient search
- [ ] Returns matching lines with context
- [ ] Supports file pattern filtering
- [ ] Only searches cached files
- [ ] Handles special characters in query
- [ ] Limits results to avoid overwhelming output

## Test Cases (using axios repo)

```gherkin
Feature: search_text tool

  Scenario: Search for string literal
    Given the axios repository is cloned
    And I have read multiple files
    When I call search_text("timeout")
    Then I should get matches containing "timeout"
    And each match should have path, line, content

  Scenario: Filter by file pattern
    Given the axios repository is cloned
    And I have read JS and MD files
    When I call search_text("axios", file_pattern="*.md")
    Then all matches should be from .md files

  Scenario: Search in comments
    Given the axios repository is cloned
    And I have read "lib/axios.js"
    When I call search_text("TODO")
    Then I should find TODO comments

  Scenario: Limited results
    Given the axios repository is cloned
    And I have read many files
    When I call search_text("function")
    Then I should get at most 20 results by default
```

## Output Format

```python
[
    {
        "path": "lib/axios.js",
        "line": 42,
        "content": "  // Set default timeout"
    },
    {
        "path": "lib/defaults.js",
        "line": 15,
        "content": "  timeout: 0,"
    }
]
```

## Implementation Notes

- Create FTS index when store is initialized
- Use triggers to keep FTS in sync with files table
- FTS query should match whole words preferably
- Line detection: split content, find matching lines
