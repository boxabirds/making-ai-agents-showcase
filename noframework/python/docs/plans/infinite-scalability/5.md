# Task 5 — Report Drafting & Citation Enforcement

## Scope
- Build DSPy `DraftReport` module that consumes prompt + retrieved context (chunks, summaries, graph slices).
- Enforce citation format (`path:line-start-line-end`) and inclusion in claims/paragraphs.
- Ensure output is a single Markdown document (primary artifact).

## Deliverables
- Drafting prompts/templates and DSPy wiring.
- Pydantic validation for draft + extracted claims metadata.

## Test Plan
- Unit: citation parser/validator; rejects malformed or missing citations.
- Integration (stub LLM): draft satisfies the arbitrary prompt intent; citations map to existing chunks/lines.
- Property: drafting respects token/context limits (bounded context injection).
- Error handling: malformed draft output retried; logs capture validation failures.
# Task 5 — Report Drafting & Citation Enforcement (Sequential)

## Scope
- Enforce citations (`path:start-end`) in drafting; repair missing/invalid citations before gating.
- Validate drafted citations against stored chunks/summaries and fix or drop unsupported claims.
- Provide a web-based harness to trigger drafting and citation validation via browser (simple FastAPI endpoint).

## Deliverables
- Drafting path that rejects drafts without required citations or with invalid references.
- Citation repair flow that re-runs retrieval to find supporting chunks and updates citations; unsupported claims flagged.
- FastAPI endpoint to run drafting on a given store and prompt (for manual checks).

## Implementation Plan
- Add a FastAPI app (`web/harness.py`) with an endpoint `/draft` that loads a persisted store, runs drafting + citation validation/repair, and returns the report.
- In code, wrap drafting to: generate draft with required citation format, parse citations, validate against chunks, repair via retrieval if needed, and drop/flag claims that remain unsupported.
- Update orchestrator to call citation enforcement before gating.

## Test Plan
- Unit: draft with missing citations is rejected; valid citations pass.
- Integration: run drafting against a small repo and ensure citations point to real chunks.
- Web harness: start app and call `/draft` against a persisted store in tests (or documented manual steps if heavy).
